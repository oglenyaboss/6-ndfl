# Техническая документация 6-НДФЛ

## Общий обзор архитектуры

6-НДФЛ - приложение на базе Next.js для обработки налоговых документов в формате XML. Архитектурно приложение разделено на клиентскую и серверную части.

## Клиентская часть

### Версии интерфейса

В приложении реализованы две версии пользовательского интерфейса:

1. **Первая версия** (`firstVersion.tsx`) - базовая реализация с основными функциями.
2. **Вторая версия** (`secondVersion.tsx`) - расширенная версия с улучшенным дизайном и дополнительными визуальными эффектами.

Переключение между версиями происходит в главном компоненте (`page.tsx`) с использованием React hooks:

```jsx
const [version, setVersion] = React.useState(2);
const changeVersion = () => {
  setVersion(version === 1 ? 2 : 1);
  setLoading(true);
};
```

### Компоненты UI

#### Базовые компоненты (`/components/ui/`)

Набор базовых компонентов, стилизованных с помощью Tailwind CSS:

- `button.tsx` - Кнопки различных стилей
- `input.tsx` - Поля ввода
- `dropdown-menu.tsx` - Выпадающие меню
- `switch.tsx` - Переключатели
- `table.tsx` и `tenStackTable.tsx` - Компоненты для отображения табличных данных

#### Компоненты UI второй версии (`/components/uiV2/`)

Расширенные компоненты с визуальными эффектами:

- `sparkles.tsx` - Эффект искр на элементах
- `bgBeams.tsx` - Фоновые световые лучи
- `lamp.tsx` - Эффект освещения от лампы
- `loading.tsx` - Анимированные индикаторы загрузки
- `parallax.tsx` - Эффект параллакса для создания глубины

### Обработка XML на клиенте

Функции для работы с XML на клиенте находятся в файле `/src/utils/functions.ts`. Основные функции:

1. **mergeXmlFiles** - объединение двух XML-файлов:

   ```typescript
   async function mergeXmlFiles(xml1: any, xml2: any) {
     // преобразование XML в объекты
     // слияние документов
     // корректировка номеров справок
   }
   ```

2. **processXmlData** - первичная обработка XML-данных:

   ```typescript
   function processXmlData(xmlString: string) {
     // парсинг XML
     // извлечение данных для отображения в таблице
   }
   ```

3. **Функции исправления данных**:
   - `correctNegativeIncome` - исправление отрицательных доходов
   - `correctTax` - корректировка исчисленного налога
   - `setNumCorr` - установка номера корректировки
   - `nullCorr` - обнуление корректировки

## Серверная часть (API)

Серверная часть приложения реализована с помощью API Routes Next.js в директории `/src/app/api/`.

### Основные эндпоинты

1. `/api/correct-income` - исправление отрицательных доходов
2. `/api/correct-isch` - корректировка исчисленного налога
3. `/api/correct-abcorder` - сортировка по алфавиту
4. `/api/correct-numorder` - исправление нумерации
5. `/api/merge-xml` - объединение документов
6. `/api/corr` - установка номера корректировки
7. `/api/null-corr` - обнуление корректировки

### Серверные функции

Серверные функции для обработки XML находятся в файле `/src/utils/functionsBackend.js`. Эти функции вызываются из API-маршрутов и выполняют преобразования XML-документов.

#### Пример серверной функции (correctNegativeIncome):

```javascript
export async function correctNegativeIncome(xmlString) {
  try {
    // Преобразование строки XML в объект
    const obj = await parser.parseStringPromise(xmlString);

    // Логика исправления отрицательных доходов
    // ...

    // Преобразование объекта обратно в XML
    const result = builder.buildObject(obj);

    // Конвертация в windows-1251 для 1С
    const buffer = iconv.encode(result, "windows-1251");

    return {
      success: true,
      xml: buffer.toString("binary"),
    };
  } catch (error) {
    return {
      success: false,
      error: String(error),
    };
  }
}
```

## Работа с кодировкой

Приложение обрабатывает XML в различных кодировках:

1. Файлы из 1С приходят в кодировке **windows-1251**
2. В JavaScript они обрабатываются как **UTF-8**
3. При сохранении файла он конвертируется обратно в **windows-1251**

```javascript
// Пример конвертации из UTF-8 в windows-1251
const buffer = iconv.encode(xmlString, "windows-1251");
const result = buffer.toString("binary");
```

## Настройка Google Analytics

Для отслеживания использования приложения используется Google Analytics. Конфигурация находится в файле `ga.env.local`:

```
NEXT_PUBLIC_GOOGLE_ANALYTICS= 'G-ZHN6LD7S74'
```

## Оптимизация производительности

### Обработка больших файлов

При работе с большими XML-файлами используются следующие стратегии оптимизации:

1. **Потоковая обработка** - поэтапная обработка данных без загрузки всего файла в память
2. **Отложенный рендеринг** - отображение только видимых данных в таблице
3. **Фоновая обработка** - выполнение тяжелых операций в фоновом режиме с индикатором загрузки

## Развертывание

### Требования

- Node.js 18.x или выше
- npm или yarn

### Сборка для production

```bash
# Сборка приложения
npm run build

# Запуск production-версии
npm start
```

## Известные ограничения

1. Приложение оптимизировано для работы с файлами НДФЛ версии 6.2
2. Максимальный размер обрабатываемого файла зависит от доступной памяти браузера
3. Некоторые сложные налоговые случаи могут требовать ручной коррекции

## Советы по отладке

1. Для отладки XML-преобразований рекомендуется логировать промежуточные объекты
2. При работе с кодировками используйте функцию `toString("binary")` для просмотра содержимого
3. Для анализа больших XML-файлов рекомендуется использовать специализированные XML-редакторы

## Контакты для технической поддержки

По вопросам технического характера обращайтесь:

- Email: [oglenyaboss@icloud.com](mailto:oglenyaboss@icloud.com)
- Telegram: [ll_ogl](https://t.me/ll_ogl)
- GitHub Issues: [https://github.com/oglenyaboss/6-ndfl/issues](https://github.com/oglenyaboss/6-ndfl/issues)
